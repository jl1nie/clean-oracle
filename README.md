# Clean Oracle

## 概要
「Clean Oracle」は、部屋のきれいさを判定するWebアプリケーションです。事前に登録した「神の部屋」の画像と、現在の「民の部屋」の画像を比較し、そのきれいさを判定して「神託」として表示します。

## 機能
- **「神の部屋」の登録**: きれいさの基準となる「神の部屋」の画像を登録します。
- **「民の部屋」のアップロード**: 「神の部屋」と同一位置・同一画角で撮影された「民の部屋」の画像をアップロードします。
- **きれいさの判定と神託の表示**: アップロードされた「民の部屋」の画像を「神の部屋」と比較し、きれいさを0点から100点で判定します。判定結果は「神託」として表示されます。

## 主要技術スタック
- **言語**: Python, JavaScript
- **バックエンド**: Flask, requests, gunicorn
- **フロントエンド**: React (Vite), Express
- **コンテナ**: Docker
- **LLM**: ローカルLLM (LMStudio経由でREST API呼び出し)
- **パッケージ管理**: uv
- **フォーマッター/リンター**: ruff
- **型チェック**: mypy

## インストール方法

### 前提条件
- Docker
- uv (Pythonパッケージマネージャー)
- LMStudio (ローカルLLMの実行環境)

### 1. リポジトリのクローン
```bash
git clone https://github.com/your-repo/clean-oracle.git
cd clean-oracle
```

### 2. `.env`ファイルの作成と設定
プロジェクトルートに`.env`ファイルを作成し、LMStudioのAPIエンドポイントを設定します。LMStudioがホストマシンで実行されている場合、通常は以下のようになります。

```
LLM_API_URL=http://localhost:1234/v1/chat/completions
```

### 3. Docker Composeでの起動
```bash
docker compose up --build
```

### 4. ファイル権限の設定
バックエンドが画像を保存する`./images`ディレクトリは、ホストマシンの`./images`ディレクトリにマウントされます。コンテナ内のアプリケーションユーザーがこのディレクトリに書き込めるよう、ホストマシン上で適切な権限を設定する必要があります。例えば、現在のユーザーに所有権を与えるには、以下のコマンドを実行します。

```bash
sudo chown $(whoami):$(whoami) ./images
```

## 使い方

アプリケーションが起動したら、ブラウザでフロントエンドのURL（通常は`http://localhost:5173`）にアクセスします。

### 「神の部屋」の登録
1. アプリケーションにアクセスすると、最初に「神の部屋」の登録画面が表示されます。
2. 「神の部屋」となる画像をアップロードします。
3. 登録が完了すると、画像のUUIDがブラウザに保存され、自動的に「民の部屋」のアップロード画面に遷移します。

### 「民の部屋」のアップロードと神託の取得
1. 「民の部屋」のアップロード画面で、「神託を授けます」のメッセージと「アップロード」ボタンが表示されます。
2. 「民の部屋」の画像をアップロードします。この画像は「神の部屋」と同一位置・同一画角で撮影されている必要があります。
3. 画像がアップロードされると、バックエンドで「神の部屋」との比較が行われ、LLMによるきれいさの判定と神託が生成されます。
4. 分析結果と神託が画面に表示されます。「再度トライ」ボタンで再度アップロード画面に戻ることができます。

### 設定変更
すべてのページには設定ボタンがあり、設定ダイアログでは「神を選ぶ」で「Male」または「Female」を選択し、設定情報をバックエンドに送ることができます。
